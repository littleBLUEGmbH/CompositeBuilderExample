# CompositeBuilderExample

This code is confgured to be run on the NUCLEO-G474RE evaluation board.

The purpose of this code is show the use of the composite builder to for a USB composite device with two custom hid interfaces.

The first interface is a HID multitouch, the second a vendor specific HID interface.

The hardware initialization is done with STM32CubeMX generated code.

Right now only the "Debug" configuration is supported and set.

## Successor to STM32F373 legacy code

The STM32G4 project is a successor to an existing STM32F373 project that was configured with a heavily patched version of the STM32_USB-FS-Device_Driver.

Because of this we have an existing implementation, with existing reports and report descriptors we want to mimic as closely as possible.

The expected reports can be seen in these files:

* Doc/DescriptorDump_RAFI_Glasscape_Touch STM32F373.txt
* Doc/Report Descriptor STM32F373 0 MultiTouch.txt
* Doc/Report Descriptor STM32F373 1 Vendor.txt
* Doc/Report Descriptor STM32F373 RAW.txt

## Current implementation / problems

The code generated by STM32CubeMX does not work out of the box:

* The middleware USB_DEVICE has to be disabled in the STM32CubeIDE
* Instead, STM32_USB_Device_Library-v2.11.1 is used as a submodule
* "usb_device.c" has to be updated, so both interfaces are registered
* The current version of the library does not full work; the report descriptor size for the interfaces is wrong
* To fix this, modified headers and source files are in the directory "CustomHID_Modified" and "CompositeBuilder_Modified"

With these modifications the device is enumerated and the descriptors can be read:

* The report descriptors match the precedessor
* The descriptor dump of the current implementation has some differences:
  * Interface 0 has 2 endpoints
  * Some strings are different
* The is an error (on linux): "hid-multitouch ... : failed to fetch feature 2"; this is out of the scope of this repository but needs to be addressed in the future

## Tools

* <https://www.thesycon.de/eng/usb_descriptordumper.shtml>(Thesycon USB Descriptor Dumper v2.17.0): used to create the "DescriptorDump*.txt" files
* <https://github.com/DIGImend/usbhid-dump>(Usbhid-dump): Tool on Linux used to create the RAW report descriptor dump (`sudo usbhid-dump -m 05BD`)
* <https://eleccelerator.com/usbdescreqparser/>(USB Descriptor and Request Parser): Used to paste in the RAW descriptor dump, so the parsed report descriptors
